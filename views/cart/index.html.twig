{% extends "/_layouts/base.html.twig" %}
{% import "/_macros/form-elements-bootstrap.html.twig" as forms %}
{% block title %}Shopping Cart{% endblock %}
{% block breadcrumb %}
{{ base.breadcrumbs({'Shopping Cart':''}) }}
{% endblock %}

{# Page information #}
    {#
        Visit api/cart to understand how Cart data is mapped
    #}
    {#
        Shipping and Tax estimates are handled via JS, see "block js" at
        the bottom of this page.
    #}
{# end Page information #}

{% for item, quantity in app.request.post.cart.quantity %}
	{% if quantity <= 0 %}
		{% set result = api.delete('/cart/item/' ~ item) %}
	{% else %}
		{% set result = api.put('/cart/item/' ~ item, {quantity:quantity}) %}
	{% endif %}
{% endfor %}
{% if app.request.post.cart.action|split('/')|first == 'remove' %}
	{% set result = api.delete('/cart/item/' ~ app.request.post.cart.action|split('/')|last) %}
{% endif %}
{# Remove coupon #}
{% if app.request.post.cart.action|split('/')|first == 'removecoupon' %}
	{% set cart  = api.get('/cart') %}
	{% set coupon_id = app.request.post.cart.action|split('/')|last %}
	{% set result = api.delete('/cart/discount/' ~ coupon_id) %}
{% endif %}
{# Add coupon #}
{% if app.request.post.cart.coupon_code is not empty %}
	{% set result = api.post('/cart/discount', {"type":"coupon", "code":app.request.post.cart.coupon_code}) %}
	{% if api.error %}
		{% set error="The coupon code you entered is invalid." %}
	{% endif %}
{% endif %}
{% if app.request.post.cart.shipping_country is not empty %}
	{% set result = api.post('/cart', app.request.post.cart) %}
{% endif %}
{% if api.error is not empty  and not error %}
	{% set error = api.error %}
{% endif %}


{% set add = app.request.get.add %}
{% set cou = app.request.get.coupon %}
{% if add|length > 0 or cou|length > 0 %}
    {% if add|length > 0 %}
        {% set new = add|split(',') %}
        {% for n in new %}
            {% set new2 = n|split(':') %}
            {% do api.post('/sessioncartitem', {"product_id":new2[0], "quantity":new2[1]}) %}
        {% endfor %}
    {% endif %}
    {% if cou|length > 0 %}
        {% do api.post('/cart/discount', {"type":"coupon", "code":cou}) %}
        {% if api.error %}
    		{% set error="The coupon code you entered is invalid." %}
    	{% endif %}
    {% endif %}
    {# #}
    {% do app.redirect('/' ~ app.url ~ '/cart',{}) %}
{% endif %}


{% set cart = api.get('/cart') %}

{% set shipping_methods = api.get('/shippingmethod',{query:{status:'active'}}) %}
{% set shipping_countries = api.get('/shippingmethod/country') %}
{% set site_payments = api.get('/site/payments') %}

{% if (cart.items is not empty) %}
	{% set product_ids = cart.items|values_in('product_id') %}
	{% set products = api.get('/variant',{query:{id:{'$in':product_ids}}})|group_by('id') %}

	{# Remove products that were disabled or removed #}
	{# TODO: We should probably do this outside of the template for orders #}
	{% set items_deleted = false %}
	{% for id, item in cart.items %}
		{% set product = products[item.product_id].0 %}


		{% if product.status != 'active' %}
			{% do api.delete('/cart/item/' ~ id) %}
			{% if product.title is defined %}
				{# This product is disabled or removed #}
				{% do app.user.setFlash(product.title ~ ' is no longer available.', 'info') %}
			{% else %}
				{# This product doesn't exist anymore (deleted) #}
				{% do app.user.setFlash('A product you have selected is no longer available.', 'info') %}
			{% endif %}
			{% set items_deleted = true %}
		{% endif %}
		{% if items_deleted %}
			{% do app.redirect(app.request.url) %}
		{% endif %}
	{% endfor %}
{% endif %}

{% block content %}
{# DISPLAY CART LOGIC #}
    {% set display_cart = [] %}
    {% set new_quantities = [] %}
    {% set count = 0 %}
    {# 1) Add bundles to display cart #}
    {% for discount in cart.discount_collection.discounts %}
        {% if discount.type == "bundle" %}
            {% set display_cart = display_cart|merge(
                { (count) :
                    {
                        'is_bundle': true,
                        'name': discount.model.name,
                        'description': discount.model.description,
                        'discount_value' : discount.model.discount_value,
                        'items': discount.affected_items,
                        'quantity' : discount.quantity
                    }
                }
                )
            %}
            {% set count = count + 1 %}
        {% endif %}
        {# 1.a) Recompute item quantities #}
        {% for variant in discount.model.variant_id %}
            {% set new_quantities = new_quantities|merge(
                    { ('_'~variant.id): variant.quantity * discount.quantity }
                )
            %}
        {% endfor %}
    {% endfor %}
    {# 2) Add items with new quantities #}
    {%  for item in cart.items %}
        {% if (item.quantity - new_quantities['_'~item.product_id]) > 0 %}
            {% set display_cart = display_cart|merge(
                { (count) :
                    {
                        'product_id': item.product_id,
                        'quantity': item.quantity - new_quantities['_'~item.product_id]
                    }
                }
                )
            %}
            {% set count = count + 1 %}
        {% endif %}

    {% endfor %}
{# END DISPLAY CART LOGIC #}

{% if error is not empty %}
	<div class="alert alert-warning">{{ error }}</div>
{% endif %}

{% if shipping_methods is empty or shipping_countries is empty %}

	<p>Acenda is not properly set up for checkout. Please add an active shipping method with at least one valid shipping zone.</p>

{% else %}
<h1>Shopping Cart</h1>

{% if (cart.items is empty) %}

<p>Your Shopping Cart is empty.</p>
<a class="btn btn-default" href="{{app.url}}">Continue Shopping</a>

{% else %}

<style>
/*
.quantity>.input-group {width:100%;}
.quantity .input-group-btn {width:1%;}
.quantity .cart-indiv.input-group-btn {width:26%;}
.quantity .cart-total.input-group-btn {width:34%;}
*/
</style>
<h2>Products</h2>


{{ forms.begin('cart','','post', {class:'form-cart g mb-4 divide'}) }}
{% for id, item in cart.items %}
{% set product = products[item.product_id].0 %}
{% set parent = api.get('product/' ~ product.product_id)%}
{% spaceless %}
<div class="divide item mb-4 pb-4" data-id="{{product.product_id}}" data-vid="{{product.id}}"{% if product.sku is not empty %} data-sid="{{product.sku}}"{% endif %}>
	<div class="row">
		<div class="col-md-6">
			<div class="media media-cart mb-0 p-xs">
				<div class="media-left">
					<img class="media-object" src="{{ product.thumbnail }}" width="250" height="250" alt="">
				</div>
				<div class="media-body">
				{% if product.brand is not empty %}
    				<div class="brand mb-2">
    					<a href="{{app.url}}/brand/{{product.brand|url_encode}}"><span itemprop="brand">{{product.brand}}</span></a>
    				</div>
    			{% endif %}
					<div><h3 class="product-name"><a href="{{ app.url ~ '/product/' ~ parent.slug }}">{{ product.name }}</a></h3></div>
					
					{#<div class="availability mb-3">
						{% if product.has_stock %}
							In Stock
						{% elseif variation.inventory_shipping_estimate is not empty %}
							<span class="text-danger">
								{{ variation.inventory_shipping_estimate }}
							</span>
						{% else %}
							<span class="text-danger">
								Out of Stock
							</span>
						{% endif %}
					</div>#}
					{% if (item.wishlist_id is not empty) %}
					{% set wishlist = api.get('/wishlist/' ~ item.wishlist_id) %}
					<p><a href="{{ app.url }}/wishlist/{{ wishlist.id }}"><i class="fa fa-list"></i><span>For {{ wishlist.name }}</span></a></p>
					{% endif %}
					{% if (item.registry_id is not empty) %}
					{% set registry = api.get('/registry/' ~ item.registry_id) %}
					<p><a href="{{ app.url }}/registry/{{ registry.id }}"><i class="fa fa-gift"></i><span>For {{ registry.name}}</span></a></p>
					{% endif %}
					<button class="btn btn-link btn-xs px-0 btn-remove-all" type="submit" name="cart[action]" value="remove/{{ id }}"><i class="fa fa-close"></i><span>Remove</span></button>
					<div class="error alert alert-danger" style="display:none"></div>

				</div>
			</div>
		</div>

		<div class="col-md-6 col-lg-5 offset-lg-1">
            <label for="quantity-selector-{{id}}">Qty</label>
			<div class="row quantity">
                <div class="col-8 cart-indiv">
					<div class="input-group igq-mod">
						<div class="mr-1">
							<input type="text" class="form-control form-control-lg quantity-selector px-1 text-center" id="quantity-selector-{{id}}" data-id="{{id}}" data-model="cart/item" name="cart[quantity][{{ id }}]" value="{{ item.quantity }}">
						</div>
						<div class="btn-group-vertical mr-4">
						    <button class="btn btn-default btn-xs btn-sq-xs btn-add" type="button"><i class="fa fa-chevron-up"><span class="sr-only">Increase Qty</span></i></button>
						    <button class="btn btn-default btn-xs btn-sq-xs btn-remove" type="button"><i class="fa fa-chevron-down"><span class="sr-only">Decrease Qty</span></i></button>
						</div>
						<div class="pricing">
							<div class="price">
								{{ prod.currency(product.price|number_format(2)) }}
							</div>
							{% if product.compare_price is not empty and product.compare_price > product.price %}
							<div class="fsd1 price-regular">
								{{ prod.currency(product.compare_price|number_format(2)) }}
							</div>
							{% endif %}
						</div>
					</div>
				</div>
				<div class="col-4 cart-total text-right">
					{% set price = product.price * item.quantity %}
					<div class="pricing">
						<div class="price">
							{{ prod.currency(price|number_format(2)) }}
						</div>
						{% if product.compare_price is not empty and product.compare_price > product.price %}
						<div class="fsd1 percent">
							{{ prod.saveprice((product.save_price * item.quantity)|number_format(2)) }}
						</div>
						{% endif %}
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
{% endspaceless %}
{% endfor %}
{{ forms.end() }}
<div class="row">
    {% set has_bundle = false %}
    {% for index, discount in cart.discount_collection.discounts %}
        {% if discount.type == 'bundle' and discount.affected_items is not empty %}
            {% set has_bundle = true %}
        {% endif %}
    {% endfor %}
	<div class="col-lg-7">
		<h2>Coupon Code</h2>
        {{ forms.begin('cart','','post', {class:'form-coupon needs-validation divide pb-4 mb-4',id:'coupon-code'}) }}
        {% if has_bundle %}
        <div class="p divide" id="bundles">
			<div class="title fa-fa-balance"><i class="fa fa-object-group"></i><b>Bundles</b></div>
			<div class="form-group">
				{% for index, discount in cart.discount_collection.discounts %}
					{% if discount.type == 'bundle' %}
						<p><i class="fa fa-caret-square-o-right"></i><span>A few of your items are part of the bundle "{{ discount.model.name }}" that gives you ${{ discount.amount }} off your total cart amount.</span></p>
					{% endif %}
				{% endfor %}
			</div>
		</div>
        {% endif %}

		<div class="form-group">
			<label for="cart_coupon_code">Enter Coupon Code:</label>
			<div class="row">
				<div class="col-6 col-md-8">
					{{ forms.text('cart[coupon_code]', coupon_code, {class:'form-control parsley-validated', id:'cart_coupon_code', placeholder: "Coupon Code", required:true}) }}
				</div>
				<div class="col-6 col-md-4">
					{{ forms.submit('cart[action]', 'enter_coupon', 'Apply', {class:'btn btn-default btn-block', id: 'cart_Enter Coupon'})}}
				</div>
			</div>
			<div class="validation">{{ forms.errorlist(form_errors, 'coupon_code') }}</div>
		</div>
		{% for id, discount in cart.discount_collection.discounts %}
			{% if discount.type == 'coupon' %}
			<div class="discount">
				<div class="alert alert-info">
					{{ forms.submit('cart[action]', "removecoupon/" ~ discount.id, 'Remove', {class:' float-right btn btn-info btn-xs', id: 'cart_Enter Coupon'}) }}
					
					<p>
					<b>Coupon: {{ discount.code }}</b>
					{% if discount.description is not empty %}<br>{% endif %}
					{{ discount.description }}
					</p>

				</div>
			</div>
			{% endif  %}
		{% endfor %}
        {{ forms.end() }}
		{# Begin shipping estimator #}
        <div class="mb-4" id="shipping-estimator">
			{% include "/cart/_partials/estimator.html.twig" %}
		</div>
		{# End shipping estimator #}
	</div>
	<div class="col-lg-5">
		<div class="card"><div class="card-body">
			<div class="p">
				<div class="row estimate-subtotal">
					<div class="col-7">Subtotal:</div>
					<div class="col-5 text-right">
						{{ prod.currency(cart.item_subtotal|number_format(2)) }}
					</div>
				</div>
				{% if cart.shipping_rate != null %}
				<div class="row rate-estimate-checkout">
					<div class="col-7">
						Shipping<span data-tooltip data-toggle="tooltip" data-placement="top" data-original-title="Estimated shipping rate.">*</span>:
					</div>
					<div class="col-5 text-right">
						{{ prod.currency(cart.shipping_rate|number_format(2)) }}
					</div>
				</div>
				{% endif %}
				{% set coupon_discount = 0 %}
				{% set bundle_discount = 0 %}
				{% for dsc in cart.discount_collection.discounts %}
					{% if dsc.type == "coupon" %}
						{% set coupon_discount = coupon_discount + dsc.amount %}
					{% elseif dsc.type == "bundle" %}
						{% set bundle_discount = bundle_discount + dsc.amount %}
					{% endif %}
				{% endfor %}

				{% if coupon_discount > 0 %} 
				<div class="row estimate-coupons">
					<div class="col-7">Coupons:</div>
					<div class="price-discount col-5 text-right">
						-{{ prod.currency(coupon_discount|number_format(2)) }}
					</div>
				</div>
				{% endif %}
				
				{% if bundle_discount > 0 %}
				<div class="row estimate-bundles">
					<div class="col-7">Bundles:</div>
					<div class="price-discount col-5 text-right">
						-{{ prod.currency(bundle_discount|number_format(2)) }}
					</div>
				</div>
				{% endif %}
				{% if cart.tax_rate != null %}
				<div class="row total-before-tax">
					<div class="col-7">Total Before Tax:</div>
					<div class="col-5 text-right">
						{{ prod.currency((cart.adjusted_subtotal+cart.shipping_rate)|number_format(2)) }}
					</div>
				</div>
				<div class="row tax-estimate-checkout">
					<div class="col-7">Sales Tax<span data-tooltip data-toggle="tooltip" data-placement="top" data-original-title="Estimated Sales Tax.">*</span>:</div>
					<div class="col-5 text-right">
						{{ prod.currency(cart.tax_rate|number_format(2)) }}
					</div>
				</div>
				{% endif %}
				<hr>
				<div class="row estimate-total totals-total">
					<div class="col-7">Total<span data-tooltip data-toggle="tooltip" data-placement="top" data-original-title="Estimated order total. Exact total including shipping cost and sales tax will be calculated during checkout.">*</span>:</div>
					<div class="col-5 text-right">
						{{ prod.currency(cart.total|number_format(2)) }}
					</div>
				</div>
			</div>
			{% set permissions = api.get('/customer/permissions') %}
			{% if permissions.browse_catalog and permissions.show_prices and permissions.place_order %}
				{% if site_payments.has_regular_checkout == true %}

					<div class="p" id="proceed-to-checkout">
						<a class="btn btn-block btn-lg btn-primary btn-cart" href="{{ app.url }}/checkout">Proceed To Checkout</a>
					</div>

				{% endif %}
				{% if site_payments.has_express_checkout == true and site_payments.express_payment_method == "paypal express" %}

					<div class="text-center" id="paypal">
						<a href="{{ app.url }}/checkout/paypal"><img src="https://www.paypal.com/en_US/i/btn/btn_xpressCheckout.gif" alt="Paypal Check out" width="145" height="42"></a>
					</div>
				{% endif %}
			{% else %}
				<div class="text-center" id="paypal">
					You cannot place an order at this time.
				</div>
			{% endif %}

		</div></div>
	</div>
</div>

{% endif %}
{% endif %}
{% endblock %}

{% block acenda %}
	{{ parent() }}
	{% include "/cart/_partials/acenda.html.twig" %}
{% endblock %}
{% block dataLayer %}
{% include "/cart/_partials/dataLayer.html.twig" %}
{{ parent() }}
{% endblock %}
