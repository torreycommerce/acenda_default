{% import "/_macros/form-elements-bootstrap.html.twig" as form %}
{% import "/_macros/lonely-form.html.twig" as lonelyform %}
{% extends "/_layouts/base.html.twig" %}
{% set title = 'Create a Review' %}
{% block title %}{{title}}{% endblock %}
{% set product_id = app.request.path|split('/')|last %}
{% if not product_id or product_id is not integer %}
    {% do app.redirect('/',{'error':'The review you requested is not available.'}) %}
{% endif %}
{% set product = api.get('/product/' ~ product_id) %}
{% if product == false %}
    {% set product = api.get('/collection/' ~ product_id) %}
{% endif %}
{% set address_result = api.get('/customeraddress',{"query": { "customer_id":app.user.id, "default":1 }} ) %}

{% if not product.id %}
    {% do app.redirect('/') %}
{% endif %}

{% if address_result.0 is defined %}
    {% set address = address_result.0 %}
{% endif %}

{% if not app.user.isLoggedIn() %}
    {% set login_redirect_url = '/review/id/'~ product_id %}
    {% do app.redirect('/account/login/' ~ app.request.url) %}
{% else %}
    {% if app.request.post.review is defined %}
        {% set review = app.request.post.review + {'customer_id':app.user.id,'status':'pending'} %}
        {% if api.post('/productreview', review) %}
            {% do app.redirect('/product/' ~ product.slug, {'success':'Thank you. Your review has been submitted for approval.'}) %}
        {% else %}
            {% set form_errors = api.error() %}
        {% endif %}
    {% endif %}
{% endif %}

{% block breadcrumb %}
{{ base.breadcrumbs({'Write a Review':''}) }}
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="page-header">Write a Review</h1>
        {{ lonelyform.begin('review-product')}}
            {{ lonelyform.beginintro() }}
                <p>Write a Review about this product, and share your experience with others.</p>
            {{ lonelyform.endintro() }}
        {% if form_errors is not empty %}
            {{ forms.errorlist(form_errors, 'name') }}
        {% endif %}
        {# You must be logged in to review an item #}
        {{ form.begin('review','','post', {class:'form-region'}) }}
            {{ form.hidden('review[product_id]', product_id) }}
            <fieldset>
                <legend>Identity</legend>
                <div class="form-group">
                    <label class="control-label" for="first-name">First Name <span class="text-danger">*</span></label>
                    {{ form.text('review[first_name]',review.first_name|default(app.user.first_name), {class:'form-control parsley-validated', id:'first-name', placeholder:"First Name", required: true}) }}
                    <div class="validation">{{ form.errorlist(form_errors, 'first_name') }}</div>
                </div>
                <div class="form-group">
                    <label class="control-label" for="email">Email <span class="text-danger">*</span></label>
                    {{ form.email('review[email]',review.email|default(app.user.email), {class:'form-control parsley-validated', id:'email', placeholder:"Email", required: true}) }}
                    <div class="validation">{{ form.errorlist(form_errors, 'email') }}</div>
                </div>
                <div class="form-group">
                    <label class="control-label" for="city">City <span class="text-danger">*</span></label>
                    {{ form.text('review[city]',review.city|default(address.city), {class:'form-control parsley-validated', id:'city', placeholder:"City", required: true}) }}
                    <div class="validation">{{ form.errorlist(form_errors, 'city') }}</div>
                </div>
                <div class="row">
                    <div class="col-xs-6">
                        <div class="form-group">
                            <label class="control-label" for="state">State <span class="text-danger">*</span></label>
                            {{ form.select('review[state]',review.state|default(address.state), {}, {class:'form-control parsley-validated', id:'state_select', placeholder:"State", required:true,id:'state_select'}) }}
                            <div class="validation">{{ form.errorlist(form_errors, 'state') }}</div>
                        </div>
                    </div>
                    <div class="col-xs-6">
                        <div class="form-group">
                            <label class="control-label" for="country">Country <span class="text-danger">*</span></label>
                            {{ form.select('review[country]',review.country|default(address.country), {}, {class:'form-control parsley-validated', id:'country', placeholder:"Country", required:true,id:'country'}) }}
                            <div class="validation">{{ form.errorlist(form_errors, 'country') }}</div>
                        </div>
                    </div>
                </div>
            </fieldset>
            <fieldset>
                <legend>Review - <small>{{ product.name }}</small></legend>
                <div class="form-group">
                    <label class="control-label" for="review-title">Review Title <span class="text-danger">*</span></label>
                    {{ form.text('review[title]',review.title, {class:'form-control parsley-validated', placeholder:"Title", id:'review-title', required: true}) }}
                    <div class="validation">{{ form.errorlist(form_errors, 'title') }}</div>
                </div>
                <div class="form-group">
                    <label class="control-label" for="review-description">Review Description <span class="text-danger">*</span></label>
                    {{ form.textarea('review[comment]',review.comment, {class:'form-control parsley-validated', id:'review-description', placeholder:"Description", required: true}) }}
                    <div class="validation">{{ form.errorlist(form_errors, 'comment') }}</div>
                </div>
            </fieldset>
            <fieldset>
                <legend>Ratings</legend>
                <div class="form-group text-center">
                    <label class="center-block" for="overall-review">Overall Rating</label>
                    {{ form.rating('review[score]',review.score|default('0.0'),'glyphicon-star') }}
                </div>
                <div class="form-group actions text-center">
                    {% if create %}
                        {{ form.submit('review[action]', 'create', 'Create Review', {class:'btn btn-lg btn-primary'})}}
                    {% else %}
                        {{ form.submit('review[action]', 'save', 'Create Review', {class:'btn btn-lg btn-primary'})}}
                    {% endif %}
                </div>
            </fieldset>
        {{ form.end() }}
        {{ lonelyform.end() }}
    </div>
</div>
{% endblock %}
{% block js %}
{{ app.asset.js(app.url_asset ~ '/assets/js/region.js') }}
{% endblock %}
