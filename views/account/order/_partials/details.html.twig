{% if (app.request.post and app.request.post.return) %}
	{% if (api.put('/orderreturn/' ~ app.request.post.return ~ '/cancel')) %}
		<div class="alert alert-dismissible alert-block alert-success flash-note-success">
			<button type="button" class="close" data-dismiss="alert"><i class="fa fa-times"><i class="sr-only">Close</i></i></button>
			Return successfully cancelled
		</div>
	{% endif %}
{% endif %}

{% if order.test_order %}

<div class="alert alert-danger"><h1>This is a test order.</h1></div>

{% endif %}
<h1>Order Details</h1>
<div class="card">
	<div class="card-header">
		<h2>Order: #{{ order.order_number }}</h2>
	</div>
	<div class="card-body">
	<div class="row">
		{# Begin order details #}
		<div class="order-details col-md-4">
			
			{# Begin order details #}
			<div class="p-2x">
				<h3>Order Info</h3>
				<div>Order: #{{ order.order_number }}</div>
				<div>{{ order.date_created }}</div>
				<div>Order Total: {{ prod.currency(order.total|number_format(2, '.')) }}</div>
			</div>
			{# End order details #}
				
			{# Begin shipping Address #}
			<div class="p-2x">
				<h3>Shipping Address</h3>
				<address>
					<div>{{ order.shipping_first_name}} {{ order.shipping_last_name}}</div>
					{% if order.giftlist_present is empty %}
					<div>{{ order.shipping_street_line1}}</div>
					{% if order.shipping_street_line2 is not empty %}
					<div>{{ order.shipping_street_line2}}</div>
					{% endif %}
					<div>{{ order.shipping_city}}, {{ order.shipping_state}} {{ order.shipping_zip}}</div>
					{% endif %}
				</address>
			</div>
			{# End shipping Address #}
				
			{# Begin shipment details #}
			<div class="p-2x">
				{% set method = api.get('/shippingmethod/' ~ order.shipping_method) %}
				<h3>Shipping Method</h3>
				<div>Shipping Method: ({{method.name}})</div>
			</div>
			{# End shipment details #}

			{# Begin order actions #}
			
			<div class="p-2x">
				{% if order.status == 'pending' %}
				<a class="btn btn-default" data-toggle="modal" data-target="#cancel-modal">Cancel Order</a>
				<div class="modal fade" id="cancel-modal" tabindex="-1" role="dialog" aria-labelledby="cancel-modal-label" aria-hidden="true">
					<div class="modal-dialog">
						<div class="modal-content">
							<div class="modal-header">
								<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
								<h4 class="modal-title" id="cancel-modal-label">Cancel Order</h4>
							</div>
							<div class="modal-body">Are you sure you want to cancel this order?</div>
							<div class="modal-footer">
								{{ form.begin('',app.url ~ '/order/actions') }}
								<a class="btn btn-default" data-dismiss="modal">Back</a>
								<button name="action" value="cancel" class="btn btn-danger">Cancel Order</button>
								<input type="hidden" name="email" value="{{order.email}}">
								<input type="hidden" name="id" value="{{order.order_number}}">
								{{ form.end() }}
							</div>
						</div>
					</div>
				</div>
				{% endif %}
				{% if order.returnable_items > 0 %}
					<div class="actions">
						<a href="{{ app.url ~ '/account/return/create/'~order.order_number }}" class="btn btn-default">Return Item(s)</a>
					</div>
				{% endif %}
			</div>
			{# End order actions #}
		</div>
		{# End order details #}
		<div class="col-md-8">
			<div class="divide p-2x">
			    <h3>Ordered Items</h3>
				{# Begin order items #}
				{% set items = api.get('/orderitem?email=' ~ app.request.post.order.email ~ '&order_number=' ~ app.request.post.order.number, {query:{order_id:order.id}}) %}
				{% set product_ids = items|values_in('product_id') %}
				{% set products = api.get('/variant',{query:{id:{'$in':product_ids}}})|group_by('id') %}
				{% if items is not empty %}
				{% set subtotal = 0 %}
				{% for item in items %}
				{% set product = products[item.product_id].0 %}
				{% set subtotal = subtotal + (product.price * item.quantity) %}
				<div class="order-item pad-b divide g p">
				<div class="media">
					<div class="media-left">
						<img class="media-object" src="{{ product.thumbnail }}" width="250" height="250" alt="">
					</div>
					<div class="media-body">
						<div class="product-name">
							<a href="{{ app.url ~ product.url }}" target="_blank">{{ product.name }}</a>
						</div>

						<div class="pricing">
							<div class="price">Price: {{ prod.currency(product.price|number_format(2, '.')) }}</div>
						</div>

						<div>Qty: {{ item.quantity }}</div>
					
						{% if item.tracking_number is not empty %}
						<div>Tracking Number: <a href="http://www.google.com/search?q={{ item.tracking_number }}">{{ item.tracking_number }}</a>
						</div>
						{% endif %}

						{% if item.wishlist_id is not empty %}
						<div>
						(for wishlist)
						</div>
						{% endif %}

						{% if item.registry_id is not empty %}
						<div>
						(for registry)
						</div>
						{% endif %}

						<div class="mar-t">Status: <b>{{ item.fulfilled_quantity }}</b> item(s) fulfilled.</div>
					</div>
				</div>
				</div>
				{% endfor %}
			</div>

			{% set fulfillments = api.get('/orderfulfillment?email=' ~ app.request.post.order.email ~ '&order_number=' ~ app.request.post.order.number) %}
			{% if fulfillments is not empty and fulfillments|length > 0 %}
			<div class="divide p-2x">
				{% for f in fulfillments %}
					<p class="p-2x">
						On {{ f.date_created|date("m/d/Y") }} at {{ f.date_created|date("H:i:s") }} a shipment left our warehouse
						{% if f.tracking_numbers is not empty and f.tracking_numbers|length > 0 %}
							with the following tracking number(s):</p>
							<ul>
								{% for t in f.tracking_numbers %}
									<li>{{ t }}</li>
								{% endfor %}
							</ul>
						{% else %}
							without a tracking number.</p>
						{% endif %}
				{% endfor %}
			</div>
			{% endif %}

			<div class="row">
				{# Begin billing address #}
				<div class="col-md-6">
					<div class="p-2x">
						<h3>Billing Address</h3>
						{% if order.transaction_type == 'PayPal' %}
						<address>
							<div>{{ order.billing_first_name}} {{ order.billing_last_name}}</div>
							<div>{{ order.billing_street_line1}}</div>
							<div>{% if order.billing_street_line2 is not empty %}
							{{ order.billing_street_line2}}
							{% endif %}
							</div>
							<div>{{ order.billing_city}}, {{ order.billing_state}} {{ order.billing_zip}}</div>
						</address>
						{% else %}
						Express order
						{% endif %}
					</div>
					<div class="p-xs-2x">
						<h3>Billing Method</h3>
						{% if order.transaction_type == 'PayPal Express' %} {# Express order #}
						<div>
							PayPal Express
						</div>
						{% else %}
						<div>
							{{ order.card_type|capitalize }} x-{{ order.card_last4 }} Credit Card
						</div>
						{% endif %}
					</div>
				</div>
				{# End billing address #}
				{# Begin order totals #}
				<div class="col-md-6">
					<div class="row">
						<div class="col-6">Subtotal:</div>
						<div class="col-6 text-right">{{ prod.currency(order.item_subtotal|number_format(2, '.')) }}</div>
					</div>
					<div class="row">
						<div class="col-6">Shipping:</div>
						<div class="col-6 text-right">{{ prod.currency(order.shipping_rate|number_format(2, '.')) }}</div>
					</div>
					{% if order.discount_price > 0 %}
					<div class="row">
						<div class="col-6">Discount:</div>
						<div class="col-6 price-discount text-right">-{{ prod.currency( order.discount_price|number_format(2, '.')) }}</div>
					</div>
					{% endif %}
					<div class="row">
						{% set total_before_tax = order.item_subtotal - order.discount_price + order.shipping_rate %}
						<div class="col-8">Total Before Tax:</div>
						<div class="col-4 text-right">{{ prod.currency(total_before_tax|number_format(2, '.')) }}</div>
					</div>
					<div class="row">
						<div class="col-6">Sales Tax:</div>
						<div class="col-6 text-right">{{ prod.currency(order.tax|number_format(2, '.')) }}</div>
					</div>
					<hr>
					<div class="row totals-total">
						<div class="col-6">Total:</div>
						<div class="col-6 text-right">{{ prod.currency(order.total|number_format(2, '.')) }}</div>
					</div>
				</div>
				{# End order totals #}
			{% endif %}
			</div>
		</div>
	</div>
	</div>
</div>
{# Begin returns #}
{% set returns = api.get('/orderreturn?email=' ~ app.request.post.order.email ~ '&order_number=' ~ app.request.post.order.number, {query:{order_id:order.id}}) %}
{% if returns is not empty %}

<div class="card"><div class="card-body">

	<h2>Returns</h2>

	{% for return in returns %}
	{% set item = api.get('/orderitem/' ~ return.item_id ~ '?email=' ~ app.request.post.order.email ~ '&order_number=' ~ app.request.post.order.number) %}
	<div class="divide p pad-b">
		{% if return.status =='pending' %}
		{# Begin actions #}
		<div class="actions">
		{{ forms.begin('cancel-return',app.request.path) }}
			<input type="submit" name="cancel" value="Cancel" class="btn btn-default btn-sm float-right" />
			<input type="hidden" name="id" value="{{item.id}}">
			<input type="hidden" name="return" value="{{return.id}}">
			<input type="hidden" name="order[email]" value="{{ app.request.post.order.email }}">
			<input type="hidden" name="order[number]" value="{{ app.request.post.order.number }}">
		{{ forms.end() }}
		</div>
		{# End actions #}
		{% endif %}
		<div><b>RMA:</b> {{ return.rma }}</div>
		<div class="product-name">{{ item.name }}</div>
		<div><b>Qty:</b> {{ return.quantity }}, <b>Status:</b> {{ return.status }}</div>
	</div>
	{% endfor %}
</div></div>

{% endif %}