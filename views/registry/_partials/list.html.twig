{% set registry_items = api.get('/registryitem', {query:{'registry_id': registry.id}}) %}
{% if (registry_items is empty) %}
<div class="row">
    <div class="col-md-12">
        <i>There are no items in this registry.</i><br />
        <i>Please browse the store to add more items.</i><br /><br />  
        <a class="btn btn-primary" href="{{app.url}}">Continue Shopping</a>
        {% if registry.customer_id == app.user.id %}
        <a class="btn btn-default btn-edit editregistryLink" href="{{ app.url }}/account/registry/{{ registry.id }}/edit">Manage Registry</a>
        {% endif %}
    </div>
</div>
{% else %}
<section id="registry">
    <h1><i class="fa fa-gift"></i><span>{{ registry.name }}</span></h1>

    {{ forms.begin('registry-form', app.url ~ '/registry/' ~ registry.id ~ '/route') }}   
    {% set product_ids = registry_items|values_in('product_id') %}
    {% set products = api.get('/variant',{query:{id:{'$in':product_ids}}})|group_by('id') %}
    {# Remove products that were disabled or removed #}
    {% set items_deleted = false %}
    {% for item in registry_items %}
        {% set product = products[item.product_id][0] %}
        {% if product.status != 'active' %}
            {% do api.delete('/registryitem/' ~ item.id) %}
            {% if registry.customer_id == app.user.id %}
                {# FIXME: These flash messages don't work sometimes #}
                {% if product.title is defined %}
                    {# This product is disabled or removed #}
                    {% do app.user.setFlash(product.title ~ ' is no longer available.', 'info') %}
                {% else %}
                    {# This product doesn't exist anymore (deleted) #}
                    {% do app.user.setFlash('A product you have selected is no longer available.', 'info') %}
                {% endif %}
            {% endif %}
            {% set items_deleted = true %}
        {% endif %}
        {% if items_deleted %}
            {% do app.redirect(app.request.url) %}
        {% endif %}
    {% endfor %}
    {% for item in registry_items %}
        {% set left = item.quantity - item.quantity_purchased < 0 ? 0 : item.quantity - item.quantity_purchased %}
        {% set product = products[item.product_id][0] %}
        {# Begin product #}
    <div class="product">
        <div class="row">{# End Row #}
            {# Begin product header - Mobile #}
            <div class="col-xs-12 col-sm-12 hidden-md hidden-lg">
                <header class="mobile">
                    <div class="name"><a href="{{app.url}}{{ product.url }}">{{ product.name }}</a></div>
                </header>
            </div>
            {# End product header - Mobile #}
            {# Begin product image #}
            <div class="col-xs-12 col-sm-3 col-md-3 col-lg-2">
                <div class="images">
                    <div class="thumbnail">
                        <img onerror="this.src='{{ app.url_asset }}/assets/images/product/image-250x250.jpg'" src="{{ product.thumbnail }}" />
                    </div>
                </div>
            </div>
            {# End product image #}
            {# Begin product details #}
            <div class="col-xs-12 col-sm-3 col-md-5 col-lg-5"> {# Begin col-sm-3 col-md-5 #}
                {# Begin desktop product header#}
                <header class="desktop hidden-xs hidden-sm">
                    <div class="name"><a href="{{app.url}}{{ product.url }}">{{ product.name }}</a></div>
                </header>
                {# End desktop product header #}
                {# Begin pricing #}
                <div class="pricing">
                    <div class="price">
                        <span class="sale">Sale:</span>&nbsp;<span class="dollar-sign">$</span><span class="amount">{{ product.price }}</span><span class="cents"></span>
                    </div>
                    <div class="stock">In Stock</div>                            
                    {% if product.compare_price %}
                    <div class="price-regular">
                        <span class="regular">Reg:</span>&nbsp;<span class="dollar-sign">$</span><span class="amount">{{ product.compare_price }}</span><span class="cents"></span>
                    </div>
                    {% endif %}                            
                </div>
                {# End pricing #}
                {# Begin quantities #}
                <div class="quantities">
                    <div class="qty-wanted">
                        <div class="{{ left ? "fg-green" : "fg-red" }}">
                            {% if left <= 0 %}
                                <span class="purchased">This item is purchased</span>
                            {% else %}
                                <span class="purchased">Wanted:</span>&nbsp;<span class="qty">{{ left }}</span>
                            {% endif %}
                        </div>
                    </div>
                    {% if registry.customer_id == app.user.id %}
                    <div class="qty-update">
                        <a href="#" class="btn btn-primary btn-xs" data-toggle="modal" data-target="#modal_{{ product.id }}">Update Qty</a>
                    </div>
                    {# Begin quantity modal #}
                    <div class="modal fade modal_list_quantity" id="modal_{{ product.id }}">
                        <div class="modal-dialog modal-sm">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                                    <h4 class="modal-title" id="myModalLabel">Update your quantities</h4>
                                </div>
                                <div class="modal-body"> {# Begin Modal-body #} 
                                    <div class="row">
                                        <div class="quantity-input-group">
                                            <div class="col-md-12">
                                                <h5>Quantity Purchased</h5>
                                            </div>
                                            <div class="col-md-12">
                                                <div class="quantity">
                                                    <div class="input-group">
                                                        <div class="input-group-btn">
                                                            <button class="btn btn-default btn-remove" type="button"><i class="fa fa-minus"></i></button>
                                                        </div>
                                                        <input class="form-control quantity-selector" type="text" value="{{ item.quantity_purchased }}" maxlength="2" placeholder="1" data-id="{{item.id}}" name="quantity_purchased[{{ item.id }}]">
                                                        <div class="input-group-btn">
                                                            <button class="btn btn-default btn-add" type="button"><i class="fa fa-plus"></i></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <hr>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="quantity-input-group">
                                            <div class="col-md-12">
                                                <h5>Quantity Wanted</h5>
                                            </div>
                                            <div class="col-md-12">
                                                <div class="quantity">
                                                    <div class="input-group">
                                                        <div class="input-group-btn">
                                                            <button class="btn btn-default btn-remove" type="button"><i class="fa fa-minus"></i></button>
                                                        </div>
                                                        <input class="form-control quantity-selector" type="text" value="{{ item.quantity }}" maxlength="2" placeholder="1" data-id="{{item.id}}" name="registryitem_quantity[{{ item.id }}]">
                                                        <div class="input-group-btn">
                                                            <button class="btn btn-default btn-add" type="button"><i class="fa fa-plus"></i></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div> {# End Modal-body #} 
                            </div>
                        </div>
                    </div>
                </div>
                {# End quantity modal #} 
                {% endif %}
                {% if registry.customer_id == app.user.id %}
                <a class="btn btn-default btn-xs"  data-toggle="modal" data-target="#modal_remove_{{ product.id }}" href="#">Remove</a>
                 {# Begin remove modal #}
                    <div class="modal fade modal_list_quantity" id="modal_remove_{{ product.id }}">
                        <div class="modal-dialog modal-sm">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                                    <h4 class="modal-title">Delete this item?</h4>
                                </div>
                                <div class="modal-body">                                            
                                    <P>Remove this item from your Registry?</P>
                                    <b>{{ product.name }}</b>                                            
                                </div>
                                <div class="modal-footer">
                                    <a href="" class="btn btn-default" data-dismiss="modal">Cancel</a>
                                    <a href="{{app.url}}/registry/item/{{ item.id }}/delete" class="btn btn-danger">Delete</a>
                                </div>
                            </div>
                        </div>                
                        {% endif %}
                    </div>
                    {# End remove modal #}
            {# End quantities #}
            </div>{# End col-sm-3 col-md-5 #}
            {# Begin product quantity and actions #}
            <div class="col-xs-12 col-sm-6 col-md-4 col-lg-5">
                <div class="actions">
                    <div class="row">
                        {# Begin product quantity #}
                        <div class="col-xs-2 col-sm-5 col-md-8 col-md-offset-1 col-lg-3 col-lg-offset-0">
                            <div class="quantity">
                                <div class="quantity-input-group">
                                <label for="quantity-selector" class="control-label">Qty</label>
                                    <div class="input-group">
                                        <div class="input-group-btn">
                                            <button class="btn btn-default btn-remove" type="button"><i class="fa fa-minus"></i></button>
                                        </div>
                                        <input class="form-control quantity-selector" type="text" value="1" maxlength="2" placeholder="1" name="add_to_cart[{{ item.id }}]">
                                        <div class="input-group-btn">
                                            <button class="btn btn-default btn-add" type="button"><i class="fa fa-plus"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {# End product quantity #}
                        {# Begin add to cart #}
                        <div class="col-xs-12 col-sm-6 col-sm-offset-6 col-md-12 col-sm-offset-0 col-lg-5 col-lg-offset-4 pull-right">
                            <div class="add-to-cart">
                                <button class="btn btn-cart btn-block" name="action" value="add/{{ item.id }}">Add to Cart</button>
                            </div>
                        </div>
                        {# End add to cart #}        
                    </div>
                </div>
            </div>
            {# Begin product quantity and actions #}
        </div> {# End Row #}
    </div>
    {% endfor %}
    {# Begin registry menu #}
    <div class="actions">
        <div class="row">
            <div class="col-sm-9">
                {% if registry.privacy == 'public' or registry.privacy == 'unlisted' %}
                <div class="input-group">
                    <span class="input-group-addon"><i class="fa fa-share"></i> Share this registry :</span>
                    <input class="form-control" style="cursor: copy;" type="text" onclick="this.select()" value="{{ app.url}}/registry/{{registry.id}}" readonly="readonly">
                </div>
                {% endif %}
            </div>
            <div class="col-sm-3">
                {% if registry.customer_id == app.user.id %}
                <a class="btn btn-default pull-right" href="{{ app.url }}/account/registry/{{ registry.id }}/edit">Manage Registry</a>
                {% endif %}
            </div>
        </div>       
    </div>
    {# End registry menu #}
    {{ forms.end() }}
</section>
{% endif %}