{% set cart = api.get('/sessioncart') %}
{% set cartitems = api.get('/sessioncartitem') %}
{# Calculate subtotal without discounts #}
{% set subtotal = 0 %}
<div class="row">
	<div class="col-xs-12">
		{% for item in cartitems %}
		{% set product = api.get('/variant/' ~ item.product_id) %}
		<div class="product col-v divide">
			<div class="row">
				{# Begin product image #}
				<div class="col-xs-3 col-md-4">
					<div class="thumbnail">
						<img onerror="this.src='{{ app.url_asset }}/assets/images/product/image-250x250.jpg'" src="{{ product.thumbnail }}" />
					</div>
				</div>
				{# End product image #}
				{% set subtotal = subtotal + product.price * item.quantity %}
				{# Begin product description #}

				<div class="description col-xs-9 col-md-8">
					<div class="name">{{ product.title }}</div>
						<div class="availability">
						  {% if product.has_stock %}
							  In Stock
						  {% elseif variation.inventory_shipping_estimate is not empty %}
							  <span class="text-danger">
								  {{ variation.inventory_shipping_estimate }}
							  </span>
						  {% else %}
							  <span class="text-danger">
								  Out of Stock
							  </span>
						  {% endif %}
						</div>
					<div class="qty">Qty: {{ item.quantity }}</div>
					<div class="amount"><span class="price">Price:</span> <span class="dollar-sign">$</span>{{ product.price|number_format(2, '.') }} <span class="each">each</span></div>
					{% if item.wishlist_id is not empty %}
						{% set wishlist = api.get('/wishlist/' ~ item.wishlist_id) %}
						<div class="wishlist">
							<a href="{{ app.url }}/wishlist/{{ item.wishlist_id }}"><i class="icon icon-list"></i> For {{ wishlist.name }}</a>
						</div>
					{% endif %}
					{% if item.registry_id is not empty %}
						{% set registry = api.get('/registry/' ~ item.registry_id) %}
						<div class="registry">
							<a href="{{ app.url }}/registry/{{ item.registry_id }}"><i class="icon icon-gift"></i> For {{ registry.name }}</a>
						</div>
					{% endif %}
				</div>
				{# End product description #}
			</div>
		</div>
		{% endfor %}
		{# Begin product actions #}
		<div class="actions text-right col-v">
			<a class="btn btn-default btn-sec btn-xs" href="{{ app.url }}/cart">Edit Cart</a>
		</div>
		{# End product actions #}
		{# Begin subtotal #}
		<div class="subtotal row">
			<div class="amount col-xs-7">Subtotal:</div><div class="amount col-xs-5 text-right"><span class="dollar-sign">$</span><span class="price">{{ cart.subtotal|number_format(2, '.') }}</span></div>
		</div>
		{# End subtotal #}
		{% if step == 'billing' %}
			<div class="shipping row">
				<div class="col-xs-7">Shipping:</div>
				{% set shipping = api.post('/shippingmethod/' ~ app.user.getState('shipping_method') ~ '/rate', {'total':cart.subtotal, 'quantity':cart.item_count}) %}
				<div class="amount col-xs-5 text-right"><span class="dollar-sign">$</span><span class="price">{{ shipping.rate|number_format(2, '.') }}</span></div>
			</div>
		{% endif %}
		{% if step == 'express' %}
			<div class="shipping row">
				<div class="col-xs-7">Shipping:</div>
				<div class="amount col-xs-5 text-right"><span class="dollar-sign">$</span><span class="price">{{ expressdetails.SHIPPINGAMT|number_format(2, '.') }}</span></div>
			</div>
		{% endif %}

		{% if cart.discount_price > 0 %}
		<div class="coupon row">
			<div class="col-xs-7">Discount:</div>
			<div class="amount col-xs-5 text-right"><span class="dollar-sign">-$</span><span class="price">{{ cart.discount_price|number_format(2, '.') }}</span></div>
		</div>
		{% endif %}


		{% if step == 'shipping' %}
			<div class="total row">
				<div class="col-xs-7"><strong>Total:</strong></div>
				{% set total = cart.subtotal|replace({',':''}) %}
				<div class="amount col-xs-5 text-right"><span class="dollar-sign"><strong>$</strong></span><span class="price"><strong>{{ total|number_format(2, '.') }}</strong></span></div>
			</div>
		{% endif %}
		{% if step == 'billing' %}
			<div class="tax row">
				<div class="col-xs-7">Total Before Tax:</div>
				{% set total_before_tax = cart.subtotal|replace({',':''}) + shipping.rate|replace({',':''}) %}
				<div class="amount col-xs-5 text-right">
					<span class="dollar-sign">$</span><span class="price">{{ total_before_tax|number_format(2, '.') }}</span>
				</div>
			</div>
			<div class="tax row">
				<div class="col-xs-7">Sales Tax:</div>
				{% if app.user.getState('shipping_zip') is empty %}
					{% set zip = api.get('/customeraddress/' ~ app.user.getState('shipping_address_id')).zip %}
				{% else %}
					{% set zip = app.user.getState('shipping_zip') %}
				{% endif %}
				{% set tax = api.post('/taxdata/calculate', {'subtotal':cart.taxableSubtotal, 'shipping_zip':zip, 'shipping_rate':shipping.rate, 'shipping_country': app.user.getState('shipping_country'), 'shipping_state': app.user.getState('shipping_state')}) %}
				<div class="amount col-xs-5 text-right">
					<span class="dollar-sign">$</span><span class="price">{{ tax.tax|number_format(2, '.') }}</span>
				</div>
			</div>
			<div class="total row">
				<div class="col-xs-7"><strong>Total:</strong></div>
				{% set total = cart.subtotal|replace({',':''}) + shipping.rate|replace({',':''}) + tax.tax|replace({',':''}) %}
				<div class="amount col-sm-5 text-right"><span class="dollar-sign"><strong>$</strong></span><span class="price"><strong>{{ total|number_format(2, '.') }}</strong></span></div>
				<input type="hidden" name="checkout[total_verify]" value="{{ total }}">
			</div>
		{% endif %}
		{% if step == 'express' %}
			<div class="tax row">
				<div class="col-xs-7">Total Before Tax:</div>
				{% set total_before_tax = cart.subtotal|replace({',':''}) + shipping.rate|replace({',':''}) %}
				<div class="amount col-xs-5 text-right">
					<span class="dollar-sign">$</span><span class="price">{{ total_before_tax|number_format(2, '.') }}</span>
				</div>
			</div>
			<div class="tax row">
				<div class="col-xs-7">Sales Tax:</div>
				{% if selected_address is empty %}
					{% set tax = api.post('/taxdata/calculate', {'subtotal':cart.subtotal, 'shipping_zip':expressdetails.SHIPTOZIP, 'shipping_rate':expressdetails.SHIPPINGAMT}) %}
				{% else %}
				{% set address = api.get('/customeraddress/' ~ selected_address) %}
					{% set tax = api.post('/taxdata/calculate', {'subtotal':cart.subtotal, 'shipping_zip':address.zip, 'shipping_rate':expressdetails.SHIPPINGAMT}) %}
				{% endif %}
				<div class="amount col-xs-5 text-right"><span class="dollar-sign">$</span><span class="price">{{ tax.tax|number_format(2, '.') }}</span></div>
			</div>
			<div class="total row">
				<div class="col-xs-7">Total:</div>
				{% set total = expressdetails.AMT|replace({',':''}) - expressdetails.TAXAMT|replace({',':''}) + tax.tax|replace({',':''}) %}
				<div class="amount col-xs-5 text-right"><span class="dollar-sign">$</span><span class="price">{{ total|number_format(2, '.') }}</span></div>
				<input type="hidden" name="checkout[total_verify]" value="{{ total }}">
			</div>
		{% endif %}
	</div>
</div>
