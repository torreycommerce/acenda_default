{% set wishlist_items = api.get('/wishlist/' ~ wishlist.id ~ '/items') %}
{% if (wishlist_items is empty) %}

<p>There are no items in this wishlist. <br />Please browse the store to add more items.</p>      
<a class="btn btn-primary" href="{{app.url}}">Continue Shopping</a>
{% if wishlist.customer_id == app.user.id %}
<a class="btn btn-default btn-edit editwishlistLink" href="{{ app.url }}/account/wishlist/{{ wishlist.id }}/edit">Manage Wish List</a>
{% endif %}

{% else %}
<h1>{{ wishlist.name }}</h1>

{{ forms.begin('wishlist-form', app.url ~ '/wishlist/' ~ wishlist.id ~ '/route') }}   
{% set product_ids = wishlist_items|values_in('product_id') %}
{% set products = api.get('/variant',{query:{id:{'$in':product_ids}}})|group_by('id') %}

{# Remove products that were disabled or removed #}
{% set items_deleted = false %}
{% for item in wishlist_items %}
{% set product = products[item.product_id][0] %}
{% if product.status != 'active' %}
{% do api.delete('/wishlistitem/' ~ item.id) %}
{% if wishlist.customer_id == app.user.id %}
{# FIXME: These flash messages don't work sometimes #}
{% if product.title is defined %}
{# This product is disabled or removed #}
{% do app.user.setFlash(product.title ~ ' is no longer available.', 'info') %}
{% else %}
{# This product doesn't exist anymore (deleted) #}
{% do app.user.setFlash('A product you have selected is no longer available.', 'info') %}
{% endif %}
{% endif %}
{% set items_deleted = true %}
{% endif %}
{% if items_deleted %}
	{% do app.redirect(app.request.url) %}
{% endif %}
{% endfor %}
	{% spaceless %}
	<div class="products mb-3 divide">
	<h2>Products</h2>
	<style>
	@media (min-width: 768px) {
		.max-sm-320 {max-width:320px; margin-right:auto; margin-left:auto;}
	}
	</style>
{% for item in wishlist_items %}
	{% set left = item.quantity - item.quantity_purchased < 0 ? 0 : item.quantity - item.quantity_purchased %}
	{% set product = products[item.product_id][0] %}
		{# Begin product #}
	<div class="divide g mb-4 pb-4">
		<div class="row">
			<div class="col-md-6">
		<div class="media media-cart mb-0 p-xs">
			<div class="media-left">
				<img class="media-object" src="{{ product.thumbnail }}" width="250" height="250" alt="">
			</div>

			<div class="media-body">

				<h3 class="product-name"><a href="{{app.url}}{{ product.url }}">{{ product.name }}</a></h3>

				{# Begin pricing #}
				<ul class="list-inline pricing">
					<li class="price">{{ prod.currency(product.price) }}</li>
					{% if product.compare_price %}
						<li class="price-regular">{{ prod.currency(product.compare_price) }}</li>
					{% endif %}
				</ul>
				{# End pricing #}
				{# Begin quantities #}
				
				<div class="fsd1 qty-wanted mb-3">
					<div class="{{ left ? "fg-green" : "fg-red" }}">
						{% if left <= 0 %}
							<span class="purchased">This item is purchased</span>
						{% else %}
							<b>Wanted:</b>&nbsp;<span class="qty">{{ left }}</span>
						{% endif %}
					</div>
				</div>
				
				<ul class="list-inline">
				{% if wishlist.customer_id == app.user.id %}
					<li class="qty-update">
						<a href="#" class="btn btn-default btn-xs" data-toggle="modal" data-target="#modal_{{ product.id }}">Update Qty</a>
					{# Begin quantity modal #}
					<div class="modal fade modal_list_quantity" id="modal_{{ product.id }}">
						<div class="modal-dialog modal-sm">
							<div class="modal-content">
								<div class="modal-header">
									<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
									<h4 class="modal-title">Update Your Quantities</h4>
								</div>
								<div class="modal-body">
									<div class="row">
										<div class="col-6">
											<label for="quantity_purchased[{{ item.id }}]">Qty <br>Purchased</label>
											<div class="input-group input-group-qty igq-mod">
												<div class="btn-group btn-group-qty">
													<input class="form-control form-control-lg quantity-selector text-center" id="quantity_purchased[{{ item.id }}]" type="text" value="{{ item.quantity_purchased }}" maxlength="2" placeholder="1" data-id="{{item.id}}" name="quantity_purchased[{{ item.id }}]">
													<button class="btn btn-default btn-xs btn-sq-xs btn-add" type="button"><i class="fa fa-chevron-up"><span class="sr-only">Increase Qty</span></i></button>
													<button class="btn btn-default btn-xs btn-sq-xs btn-remove" type="button"><i class="fa fa-chevron-down"><span class="sr-only">Decrease Qty</span></i></button>
												</div>
											</div>

										</div>
										<div class="col-6">
											<label for="wishlistitem_quantity[{{ item.id }}]">Qty <br>Wanted</label>
											<div class="input-group input-group-qty igq-mod">
												<div class="btn-group btn-group-qty">
													<input class="form-control form-control-lg quantity-selector text-center" id="wishlistitem_quantity[{{ item.id }}]" type="text" value="{{ item.quantity }}" maxlength="2" placeholder="1" data-id="{{item.id}}" name="wishlistitem_quantity[{{ item.id }}]">
													<button class="btn btn-default btn-xs btn-sq-xs btn-add" type="button"><i class="fa fa-chevron-up"><span class="sr-only">Increase Qty</span></i></button>
													<button class="btn btn-default btn-xs btn-sq-xs btn-remove" type="button"><i class="fa fa-chevron-down"><span class="sr-only">Decrease Qty</span></i></button>
												</div>
											</div>
										</div>
									</div>
								</div>
								<div class="modal-footer">
									<button class="btn btn-default" data-dismiss="modal">OK</button>
								</div>
							</div>
						</div>
					</div>
					</li>
				{% endif %}
				{# End quantity modal #}
				{% if wishlist.customer_id == app.user.id %}
					<li class="qty-remove">
						<a class="btn btn-link btn-xs"  data-toggle="modal" data-target="#modal_remove_{{ product.id }}" href="#"><i class="fa fa-close"></i><span>Remove</span></a>
					{# Begin remove modal #}
					<div class="modal fade modal_list_quantity" id="modal_remove_{{ product.id }}">
						<div class="modal-dialog modal-sm">
							<div class="modal-content">
								<div class="modal-header">
									<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
									<h4 class="modal-title">Delete this item?</h4>
								</div>
								<div class="modal-body">
									<p>Remove this item from your wish list?</p>
									<b>{{ product.name }}</b>
								</div>
								<div class="modal-footer">
									<a href="" class="btn btn-default" data-dismiss="modal">Cancel</a>
									<a href="{{app.url}}/wishlist/item/{{ item.id }}/delete" class="btn btn-danger">Delete</a>                                                
								</div>
							</div>
						</div>
					</div>
					{# End remove modal #}
					</li>
				{% endif %}
				</ul>

			</div>
		</div>
	</div>
			{# End product details #}
			{# Begin product quantity and actions #}
			<div class="col-md-5 float-right">
				<div class="actions max-sm-320">
					<div class="form-group">
						<label for="quantity-selector-{{ item.id }}" class="control-label">Qty</label>
						<div class="input-group input-group-qty igq-mod">
							<div class="btn-group btn-group-qty">
								<input type="text" value="1" maxlength="2" placeholder="1" class="form-control form-control-lg quantity-selector text-center" id="quantity-selector-{{ item.id }}" name="add_to_cart[{{ item.id }}]">
								<button type="button" class="btn btn-default btn-xs btn-sq-xs btn-add"><i class="fa fa-chevron-up"></i></button>
								<button class="btn btn-default btn-xs btn-sq-xs btn-remove" type="button"><i class="fa fa-chevron-down"><span class="sr-only">Decrease Qty</span></i></button>
							</div>
							<div class="input-group-append">
								<button class="btn btn-block btn-lg btn-primary btn-cart" name="action" value="add/{{ item.id }}">Add to Cart</button>
							</div>
						</div>
					</div>
				</div>
			</div>
			</div>
			</div>
		
	{# End product #}
{% endfor %}
</div>
{% endspaceless %}
{# Begin wishlist menu #}
<div class="actions max-sm-320">
	<div class="row">
		<div class="col-6">
			{% if wishlist.privacy == 'public' or wishlist.privacy == 'unlisted' %}
			<a class="btn btn-default btn-block" id="btn-share" href="#" data-placement="top" data-content="A link to this wish list has been copied to the clipboard." data-clipboard-text="{{ app.url}}/wishlist/{{wishlist.id}}">Share Wish List</a>
			{% endif %}
		</div>
		<div class="col-6">
			{% if wishlist.customer_id == app.user.id %}
			<a class="btn btn-default btn-block btn-edit editwishlistLink" href="{{ app.url }}/account/wishlist/{{ wishlist.id }}/edit">Manage Wish List</a>
			{% endif %}
		</div>
	</div>
</div>
{# End wishlist menu #}
{{ forms.end() }}
{% endif %}