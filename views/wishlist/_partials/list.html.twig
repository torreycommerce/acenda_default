{% set wishlist_items = api.get('/wishlist/' ~ wishlist.id ~ '/items') %}
{% if (wishlist_items is empty) %}
<div class="row">
	<div class="col-md-12">
		<i>There are no items in this wishlist.</i><br />
		<i>Please browse the store to add more items.</i><br /><br />        
		<a class="btn btn-primary" href="{{app.url}}">Continue Shopping</a>
		{% if wishlist.customer_id == app.user.id %}
		<a class="btn btn-default btn-edit editwishlistLink" href="{{ app.url }}/account/wishlist/{{ wishlist.id }}/edit">Manage Wish List</a>
		{% endif %}
	</div>
</div>
{% else %}
<div id="wishlist">
	<h1>{{ wishlist.name }}</h1>

	{{ forms.begin('wishlist-form', app.url ~ '/wishlist/' ~ wishlist.id ~ '/route') }}   
	{% set product_ids = wishlist_items|values_in('product_id') %}
	{% set products = api.get('/variant',{query:{id:{'$in':product_ids}}})|group_by('id') %}

	{# Remove products that were disabled or removed #}
	{% set items_deleted = false %}
	{% for item in wishlist_items %}
	{% set product = products[item.product_id][0] %}
	{% if product.status != 'active' %}
	{% do api.delete('/wishlistitem/' ~ item.id) %}
	{% if wishlist.customer_id == app.user.id %}
	{# FIXME: These flash messages don't work sometimes #}
	{% if product.title is defined %}
	{# This product is disabled or removed #}
	{% do app.user.setFlash(product.title ~ ' is no longer available.', 'info') %}
	{% else %}
	{# This product doesn't exist anymore (deleted) #}
	{% do app.user.setFlash('A product you have selected is no longer available.', 'info') %}
	{% endif %}
	{% endif %}
	{% set items_deleted = true %}
	{% endif %}
	{% if items_deleted %}
		{% do app.redirect(app.request.url) %}
	{% endif %}
	{% endfor %}
		<div class="products p divide">
	{% for item in wishlist_items %}
		{% set left = item.quantity - item.quantity_purchased < 0 ? 0 : item.quantity - item.quantity_purchased %}
		{% set product = products[item.product_id][0] %}
			{# Begin product #}
			<div class="pad-h divide g">
				<div class="media media-cart">
					<div class="media-left">
						<img class="media-object" onerror="this.src='{{ app.url_asset }}/assets/images/product/image-250x250.gif'" src="{{ product.thumbnail }}" width="250" height="250" alt="">
					</div>

					<div class="media-body">
					<div class="row">
					<div class="col-xs-12 col-sm-8">

						<div class="product-name"><a href="{{app.url}}{{ product.url }}">{{ product.name }}</a></div>

						{# Begin pricing #}
						<ul class="list-inline pricing fsd1">
							<li class="price">
								<span class="sale">Sale:</span>&nbsp;<span class="dollar-sign">&#36;</span><span class="amount">{{ product.price }}</span><span class="cents"></span>
							</li>
							<li class="availability">In Stock</li>
							{% if product.compare_price %}
								<li class="price-regular">
									<span class="regular">Reg:</span>&nbsp;<span class="dollar-sign">&#36;</span><span class="amount">{{ product.compare_price }}</span><span class="cents"></span>
								</li>
							{% endif %}
						</ul>
						{# End pricing #}
						{# Begin quantities #}
						<div class="quantities fsd1">
							<div class="qty-wanted p">
								<div class="{{ left ? "fg-green" : "fg-red" }}">
									{% if left <= 0 %}
										<span class="purchased">This item is purchased</span>
									{% else %}
										<span class="purchased">Wanted:</span>&nbsp;<span class="qty">{{ left }}</span>
									{% endif %}
								</div>
							</div>
							<ul class="list-inline">
							{% if wishlist.customer_id == app.user.id %}
								<li class="qty-update">
									<a href="#" class="btn btn-primary btn-xs" data-toggle="modal" data-target="#modal_{{ product.id }}">Update Qty</a>
								{# Begin quantity modal #}
								<div class="modal fade modal_list_quantity" id="modal_{{ product.id }}">
									<div class="modal-dialog modal-sm">
										<div class="modal-content">
											<div class="modal-header">
												<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
												<h4 class="modal-title">Update Your Quantities</h4>
											</div>
											<div class="modal-body">
												<div class="row">
													<div class="col-xs-12">
														<label for="quantity_purchased[{{ item.id }}]">Qty Purchased</label>
														<div class="input-group input-group-qty">
															<div class="input-group-btn">
																<button class="btn btn-default btn-remove" type="button"><i class="fa fa-minus"></i></button>
															</div>
															<input class="form-control quantity-selector text-center" id="quantity_purchased[{{ item.id }}]" type="text" value="{{ item.quantity_purchased }}" maxlength="2" placeholder="1" data-id="{{item.id}}" name="quantity_purchased[{{ item.id }}]">
															<div class="input-group-btn">
																<button class="btn btn-default btn-add" type="button"><i class="fa fa-plus"></i></button>
															</div>
														</div>
													</div>
												</div>
												
												<hr>

												<div class="row">
													<div class="col-xs-12">
														<label for="wishlistitem_quantity[{{ item.id }}]">Qty Wanted</label>
														<div class="input-group input-group-qty">
															<div class="input-group-btn">
																<button class="btn btn-default btn-remove" type="button"><i class="fa fa-minus"></i></button>
															</div>
															<input class="form-control quantity-selector text-center" id="wishlistitem_quantity[{{ item.id }}]" type="text" value="{{ item.quantity }}" maxlength="2" placeholder="1" data-id="{{item.id}}" name="wishlistitem_quantity[{{ item.id }}]">
															<div class="input-group-btn">
																<button class="btn btn-default btn-add" type="button"><i class="fa fa-plus"></i></button>
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
								</li>
							{% endif %}
							{# End quantity modal #}
							{% if wishlist.customer_id == app.user.id %}
								<li class="qty-remove">
									<a class="btn btn-default btn-sec btn-xs"  data-toggle="modal" data-target="#modal_remove_{{ product.id }}" href="#">Remove</a>
								{# Begin remove modal #}
								<div class="modal fade modal_list_quantity" id="modal_remove_{{ product.id }}">
									<div class="modal-dialog modal-sm">
										<div class="modal-content">
											<div class="modal-header">
												<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
												<h4 class="modal-title">Delete this item?</h4>
											</div>
											<div class="modal-body">
												<p>Remove this item from your wish list?</p>
												<b>{{ product.name }}</b>
											</div>
											<div class="modal-footer">
												<a href="" class="btn btn-default" data-dismiss="modal">Cancel</a>
												<a href="{{app.url}}/wishlist/item/{{ item.id }}/delete" class="btn btn-danger">Delete</a>                                                
											</div>
										</div>
									</div>
								</div>
								{# End remove modal #}
								</li>
							{% endif %}
							</ul>
						</div>
						{# End quantities #}                        
					</div>
					{# End product details #}
					{# Begin product quantity and actions #}
					<div class="col-xs-12 col-sm-4">
						<div class="actions">
							
							{# Begin product quantity #}
							
							<div class="form-group">
								<label for="quantity-selector-{{ item.id }}" class="control-label">Qty</label>
								<div class="input-group input-group-sm input-group-qty">
									<div class="input-group-btn">
										<button class="btn btn-default btn-remove" type="button"><i class="fa fa-minus"></i></button>
									</div>
									<input type="text" value="1" maxlength="2" placeholder="1" class="form-control quantity-selector text-center" id="quantity-selector-{{ item.id }}" name="add_to_cart[{{ item.id }}]">
									<div class="input-group-btn">
										<button type="button" class="btn btn-default btn-add"><i class="fa fa-plus"></i></button>
									</div>
								</div>
							</div>
							
							{# End product quantity #}
							{# Begin add to cart button #}
							
							<div class="p">
								<button class="btn btn-primary btn-cart" name="action" value="add/{{ item.id }}">Add to Cart</button>
							</div>                                    
							
							{# End add to cart button #}
							
						</div>
					</div>
					</div>
					</div>
					{# End product quantity and actions #}                    
				</div>
			</div>
		{# End product #}
	{% endfor %}
	</div>
	{# Begin wishlist menu #}
	<div class="actions">
		<div class="row">
			<div class="col-md-12 text-right">
				{% if wishlist.privacy == 'public' or wishlist.privacy == 'unlisted' %}
				<a class="btn btn-default" id="btn-share" href="#" data-placement="top" data-content="A link to this wish list has been copied to the clipboard." data-clipboard-text="{{ app.url}}/wishlist/{{wishlist.id}}"><i class="fa fa-share"></i> Share this Wish List</a>
				{% endif %}
				{% if wishlist.customer_id == app.user.id %}
				<a class="btn btn-default btn-edit editwishlistLink" href="{{ app.url }}/account/wishlist/{{ wishlist.id }}/edit">Manage Wish List</a>
				{% endif %}
			</div>
		</div>       
	</div>
	{# End wishlist menu #}
	{{ forms.end() }}
</div>
{% endif %}
